<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>HYROX DÃºo</title>
<style>
:root {
  --bg:#0b0f14;
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.72);
  --muted2:rgba(255,255,255,.56);
  --line:rgba(255,255,255,.14);
  --panel:rgba(255,255,255,.08);
  --panel2:rgba(255,255,255,.12);
  --shadow:0 18px 60px rgba(0,0,0,.55);
  --r:18px;
  --z2:#24d18f;
  --tech:#f7c948;
  --int:#ff5c7a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background: var(--bg);
  color: var(--text);
  overflow-x:hidden;
}
#bg{position:fixed; inset:0; z-index:0; pointer-events:none;}
#vignette{
  position:fixed; inset:0; z-index:1;
  background:
    radial-gradient(1200px 800px at 20% 0%, rgba(36,209,143,.12), transparent 55%),
    radial-gradient(1000px 700px at 85% 10%, rgba(247,201,72,.10), transparent 55%),
    radial-gradient(1000px 700px at 50% 110%, rgba(255,92,122,.10), transparent 55%),
    radial-gradient(900px 600px at 50% 50%, rgba(0,0,0,.18), rgba(0,0,0,.62));
  pointer-events:none;
}
header{
  position:sticky; top:0; z-index:5;
  backdrop-filter: blur(12px);
  background: linear-gradient(to bottom, rgba(11,15,20,.85), rgba(11,15,20,.48));
  border-bottom:1px solid var(--line);
}
.wrap{max-width:980px;margin:0 auto;padding:12px 14px}
.top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:10px;min-width:240px}
.iso{
  width:40px;height:40px;border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  overflow:hidden;
  display:grid;place-items:center;
}
.iso img{width:100%;height:100%;object-fit:cover;display:none}
.iso .fallback{font-weight:900;color:rgba(255,255,255,.78)}
.logo{height:26px;display:none}
.title{display:flex;flex-direction:column;gap:2px}
.title .h{font-weight:900;letter-spacing:.35px;font-size:14px}
.title .s{font-size:12px;color:var(--muted2)}
.actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select, button{
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  border-radius:12px;
  padding:10px 12px;
  outline:none;
}
button{cursor:pointer}
button:hover{background:rgba(255,255,255,.10)}

main{position:relative; z-index:2; padding:14px}
.card{
  background: linear-gradient(180deg, var(--panel2), var(--panel));
  border: 1px solid var(--line);
  border-radius: var(--r);
  box-shadow: var(--shadow);
}
.glass{backdrop-filter: blur(14px)}
.panel{padding:12px}

.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media (max-width:820px){.kpis{grid-template-columns:repeat(2,1fr)}}
@media (max-width:520px){.kpis{grid-template-columns:1fr}}
.kpi{padding:10px;border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.14)}
.val{font-weight:900;font-size:16px}
.lbl{font-size:11px;color:var(--muted2);margin-top:2px}
.badge{font-weight:900}
.badge.z2{color:var(--z2)}
.badge.tech{color:var(--tech)}
.badge.int{color:var(--int)}

.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.pill{
  padding:7px 10px;border-radius:999px;border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  font-size:12px;color:rgba(255,255,255,.86);
  cursor:pointer; user-select:none;
}
.pill:hover{background:rgba(255,255,255,.08)}

.daysRow{display:grid;gap:10px;grid-template-columns:repeat(7,1fr);margin-top:12px}
@media (max-width:900px){.daysRow{grid-template-columns:repeat(4,1fr)}}
@media (max-width:520px){.daysRow{grid-template-columns:repeat(2,1fr)}}
.dayBtn{padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(0,0,0,.18);cursor:pointer;transition: transform .12s ease, background .18s ease;min-width:0}
.dayBtn:hover{transform:translateY(-2px); background:rgba(0,0,0,.26)}

.daysRow{justify-content:flex-start}
.dayBtn{min-width:118px;max-width:160px}
@media (max-width:520px){
  .dayBtn{flex:1 1 calc(50% - 10px); max-width:none; min-width:0;}
}

.dayBtn .d{font-weight:900}
.dayBtn .t{font-size:11px;color:var(--muted2);margin-top:4px}

.overlay{
  position:fixed; inset:0; z-index:20;
  background:rgba(0,0,0,.55);
  display:none; align-items:flex-end; justify-content:center;
  padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom);
}
@media (min-width: 720px){
  .overlay{align-items:center;}
}
.sheet{
  width:min(980px, 100%);
  border-top-left-radius:22px;
  border-top-right-radius:22px;
  border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  backdrop-filter: blur(16px);
  box-shadow: 0 30px 90px rgba(0,0,0,.6);
  padding:14px;
  padding-bottom:calc(14px + env(safe-area-inset-bottom));
  max-height: 82vh;
  overflow:auto;
  transform: translateY(14px);
  opacity:0;
}
.overlay.show{display:flex}
.overlay.show .sheet{animation: sheetIn .18s ease-out forwards}
@keyframes sheetIn{to{transform:translateY(0);opacity:1}}

@media (min-width: 720px){
  .overlay.show .sheet{animation: popIn .16s ease-out forwards}
  @keyframes popIn{from{transform:scale(.98);opacity:0}to{transform:scale(1);opacity:1}}
}

.sheetHead{display:flex;justify-content:space-between;align-items:center;gap:10px}
.sheetTitle{font-weight:900}
.close{padding:8px 10px;border-radius:12px}
.section{margin-top:12px; padding:12px;border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.12)}
.section .st{font-weight:900;font-size:12px;margin-bottom:6px}
.small{font-size:12px;color:var(--muted);line-height:1.35;white-space:pre-wrap}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.tag{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:11px;color:rgba(255,255,255,.86)}
.weekList{display:grid;gap:8px}
.weekItem{
  padding:12px;border-radius:14px;border:1px solid var(--line);
  background:rgba(0,0,0,.16);cursor:pointer;
}
.weekItem:hover{background:rgba(0,0,0,.24)}
.weekItem .w{font-weight:900}
.weekItem .m{font-size:12px;color:var(--muted2);margin-top:2px}

.container{max-width:980px;margin:0 auto;padding:0 14px;}
@media (min-width:1100px){.container{max-width:940px;}}
main{padding:18px 0;}

@media (min-width: 720px){
  .sheet{
    width:min(760px, calc(100% - 24px));
    border-radius:22px;
    max-height:78vh;
  }
}


/* Modal content readability */
.modalGrid{display:grid;gap:12px}
@media (min-width:720px){
  .modalGrid{grid-template-columns: 1.35fr .65fr; align-items:start}
}
.mCol{min-width:0}
.detailsCard{
  border:1px solid var(--line);
  border-radius:16px;
  background:rgba(0,0,0,.10);
  overflow:hidden;
}
.detailsCard summary{
  list-style:none;
  cursor:pointer;
  padding:12px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  user-select:none;
}
.detailsCard summary::-webkit-details-marker{display:none}
.detailsCard summary .k{font-weight:900;font-size:12px;letter-spacing:.2px}
.detailsCard summary .hint{font-size:11px;color:var(--muted2)}
.chev{opacity:.8}
.detailsCard[open] summary{background:rgba(255,255,255,.05)}
.detailsBody{padding:10px 12px 12px}
.readable{
  font-size:12.5px;
  color:var(--muted);
  line-height:1.45;
  white-space:normal;
}
.readable p{margin:0 0 8px}
.readable ul{margin:8px 0 0 18px; padding:0}
.readable li{margin:6px 0}
.sideBox{
  border:1px solid var(--line);
  border-radius:16px;
  background:rgba(0,0,0,.10);
  padding:12px;
}
.sideTitle{font-weight:900;font-size:12px;margin-bottom:8px}
.kv{display:grid;gap:6px}
.kv .row{display:flex;gap:8px;align-items:flex-start}
.kv .key{min-width:92px;font-size:11px;color:var(--muted2)}
.kv .val{font-size:12px;color:var(--muted);line-height:1.35}
.tagWrap{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}


/* ===== Modal Dashboard Redesign ===== */
.modal-content{max-width:960px}
.modal-grid{display:grid;grid-template-columns:1.4fr .8fr;gap:16px}
@media(max-width:900px){.modal-grid{grid-template-columns:1fr}}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px}
.card h4{margin:0 0 8px;font-size:14px;letter-spacing:.04em;opacity:.9}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.1);font-size:12px}
.summary{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.summary .item{background:rgba(0,0,0,.25);border-radius:12px;padding:10px;font-size:13px}


/* --- Modal heading colors for quick scanning --- */
.h-hyp{color:var(--int)}
.h-hyrox{color:var(--tech)}
.h-run{color:var(--z2)}
.h-dist{color:rgba(255,255,255,.9)}
.h-rec{color:rgba(255,255,255,.75)}
.card h4{display:flex;align-items:center;justify-content:space-between}
.card h4 .dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:8px;opacity:.95}
.dot-hyp{background:var(--int)}
.dot-hyrox{background:var(--tech)}
.dot-run{background:var(--z2)}
.dot-dist{background:rgba(255,255,255,.65)}


/* ===== Brand Header Prominent ===== */
.brand-header{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:16px;
  padding:18px 16px 8px;
}
.brand-header img{
  max-height:64px;
}
.brand-title{
  font-size:20px;
  letter-spacing:.18em;
  font-weight:900;
}
@media(max-width:600px){
  .brand-header img{max-height:52px}
  .brand-title{font-size:16px}
}

</style>

  <!-- Password Gate (frontend) -->
  <style id="nw-gate-style">
    #nw-gate {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      padding: 24px;
    }
    #nw-gate .box{
      width: 100%;
      max-width: 360px;
      background: rgba(20,20,20,0.75);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      padding: 22px 18px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }
    #nw-gate img{
      width: 92px;
      height: 92px;
      object-fit: contain;
      margin-bottom: 12px;
      border-radius: 18px;
    }
    #nw-gate h1{
      font-size: 16px;
      margin: 6px 0 14px;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      opacity: 0.95;
    }
    #nw-gate input{
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.35);
      color: #fff;
      outline: none;
      font-size: 16px;
    }
    #nw-gate button{
      width: 100%;
      margin-top: 10px;
      padding: 12px 12px;
      border-radius: 10px;
      border: 0;
      background: #fff;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
    }
    #nw-gate .err{
      margin-top: 10px;
      font-size: 13px;
      color: #ff6b6b;
      display: none;
    }
    body.nw-locked #nw-app { display: none !important; }
  </style>

</head>
<body class="nw-locked">
  <!-- ðŸ”’ NOISELESS WORK Password Gate -->
  <div id="nw-gate" aria-modal="true" role="dialog">
    <div class="box">
      <img src="isotipo.png" alt="NOISELESS WORK" />
      <h1>NOISELESS WORK</h1>
      <input id="nw-pass" type="password" placeholder="ContraseÃ±a" onkeydown="NW_gateKey(event)" />
      <button type="button" onclick="NW_unlock()">Entrar</button>
      <div id="nw-err" class="err">ContraseÃ±a incorrecta</div>
    </div>
  </div>

  <div id="nw-app">

<div class="brand-header" style="display:none">
  <img src="isotipo.png" alt="Noiseless Work isotipo">
  <div class="brand-title">NOISELESS WORK</div>
  <img src="logotipo.png" alt="Noiseless Work logotipo">
</div>

<canvas id="bg"></canvas>
<div id="vignette"></div>

<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="iso" title="Isotipo">
          <img id="isoImg" alt="Isotipo"/>
          <div id="isoFallback" class="fallback">NW</div>
        </div>
        <img id="logoImg" class="logo" alt="Logotipo"/>
        <div class="title">
          <div class="h" id="teamTitle">HYROX DÃºo</div>
          <div class="s">Semana corta â€¢ tocÃ¡s un dÃ­a y listo</div>
        </div>
      </div>
      <div class="actions">
        <button id="weekBtn" aria-label="Elegir semana">Semana â€”</button>
        <button id="btnSim">SimulaciÃ³n</button>
        <button id="btnDuo">DÃºo</button>
        <button id="btnBrand" style="display:none">Brand</button>
      </div>
    </div>
  </div>
</header>

<main><div class="container">
  <div class="card glass panel">
    <div class="kpis">
      <div class="kpi"><div class="val" id="kmTarget">â€”</div><div class="lbl">km objetivo (incluye HYROX)</div></div>
      <div class="kpi"><div class="val"><span class="badge z2">Z2</span></div><div class="lbl">Mar/Jue @ <span id="z2hr"></span> ppm (~<span id="z2pace"></span>/km)</div></div>
      <div class="kpi"><div class="val"><span class="badge int">INT</span>/<span class="badge tech">TEC</span></div><div class="lbl">L/V umbral â€¢ MiÃ© tÃ©cnica â€¢ (V pre-sim: tÃ©cnica)</div></div>
      <div class="kpi"><div class="val" id="simYes">â€”</div><div class="lbl">simulaciÃ³n esta semana</div></div>
    </div>

    <div class="pills">
      <div class="pill" id="pillToday">Hoy</div>
      <div class="pill" id="pillNotes">Notas</div>
      <div class="pill" id="pillSeq">Secuencia</div>
    </div>

    <div class="daysRow" id="daysRow"></div>
  </div>
</div></main>

<div class="overlay" id="overlay" role="dialog" aria-modal="true">
  <div class="sheet" id="sheet">
    <div class="sheetHead">
      <div class="sheetTitle" id="sheetTitle">â€”</div>
      <button class="close" id="close">Cerrar</button>
    </div>
    <div id="sheetBody"></div>
  </div>
</div>

<script>
const DATA = {"team": "NOISELESS WORK", "today": "2026-01-31", "race": "2026-04-11", "z2_hr": 140, "z2_pace": "6:30", "stations_order": ["SkiErg", "Sled Push", "Sled Pull", "Burpee Broad Jumps", "Row", "Farmer Carry", "Sandbag Lunges", "Wall Balls"], "split_sizes": {"Mon": 3, "Wed": 2, "Fri": 3}, "hypertrophy": {"template": "Volumen guiado (sin ejercicios): 3â€“4 ejercicios totales Â· 3â€“4 series Â· 6â€“12 reps Â· RPE 7â€“8 Â· 30â€“45 min mÃ¡x", "Mon": "Pierna (cuÃ¡driceps) + Pecho + Core Â· 30â€“45 min Â· RPE 7â€“8", "Wed": "Espalda (tirÃ³n) + Pecho ligero + Core Â· 30â€“40 min Â· RPE 6â€“7", "Fri": "Pierna (posterior) + Pecho/TrÃ­ceps (mantenimiento) + Core Â· 30â€“45 min Â· RPE 7â€“8"}, "duo_roles": ["Tu compaÃ±ero marca el pace (para no destruirlo).", "TÃº abrÃ­s y cerrÃ¡s estaciones; repartos 250/500/250 para que Ã©l salga a correr descansado."], "sim_standard": ["Secuencia: Ski â†’ Push â†’ Pull â†’ Burpees â†’ Row â†’ Farmer â†’ Lunges â†’ Wall Balls", "Formato fijo (4 bloques):", "1) 500 m run + 500 m Ski (250/500/250)", "2) 500 m run + Sled Push (tÃ©cnico, continuo)", "3) 500 m run + 500 m Row (reparto similar)", "4) 500 m run + Wall Balls (50â€“70% reps objetivo)", "RPE: 7â€“8 normal; semana 9 RPE 8â€“9; nunca a muerte."], "weeks": [{"week": 1, "monday": "2026-02-02", "label": "02 Febâ€“08 Feb", "km_target": 25, "simulation": {"enabled": false, "label": ""}, "is_race_week": false}, {"week": 2, "monday": "2026-02-09", "label": "09 Febâ€“15 Feb", "km_target": 27, "simulation": {"enabled": true, "label": "SimulaciÃ³n estÃ¡ndar (Mini HYROX DÃºo)"}, "is_race_week": false}, {"week": 3, "monday": "2026-02-16", "label": "16 Febâ€“22 Feb", "km_target": 29, "simulation": {"enabled": false, "label": ""}, "is_race_week": false}, {"week": 4, "monday": "2026-02-23", "label": "23 Febâ€“01 Mar", "km_target": 31, "simulation": {"enabled": true, "label": "SimulaciÃ³n estÃ¡ndar (Mini HYROX DÃºo)"}, "is_race_week": false}, {"week": 5, "monday": "2026-03-02", "label": "02 Marâ€“08 Mar", "km_target": 25, "simulation": {"enabled": false, "label": ""}, "is_race_week": false}, {"week": 6, "monday": "2026-03-09", "label": "09 Marâ€“15 Mar", "km_target": 32, "simulation": {"enabled": true, "label": "SimulaciÃ³n estÃ¡ndar (Mini HYROX DÃºo)"}, "is_race_week": false}, {"week": 7, "monday": "2026-03-16", "label": "16 Marâ€“22 Mar", "km_target": 34, "simulation": {"enabled": false, "label": ""}, "is_race_week": false}, {"week": 8, "monday": "2026-03-23", "label": "23 Marâ€“29 Mar", "km_target": 30, "simulation": {"enabled": true, "label": "SimulaciÃ³n estÃ¡ndar (Mini HYROX DÃºo)"}, "is_race_week": false}, {"week": 9, "monday": "2026-03-30", "label": "30 Marâ€“05 Apr", "km_target": 27, "simulation": {"enabled": true, "label": "SimulaciÃ³n estÃ¡ndar (Ãºltima fuerte â€” 3 semanas antes)"}, "is_race_week": false}, {"week": 10, "monday": "2026-04-06", "label": "06 Aprâ€“11 Apr", "km_target": 12, "simulation": {"enabled": false, "label": ""}, "is_race_week": true}], "holidays_ar": ["2026-02-16", "2026-02-17", "2026-03-24", "2026-04-02"], "station_distances": {"SkiErg": "500â€“1000 m", "Sled Push": "2Ã—25 m", "Sled Pull": "2Ã—25 m", "Burpee Broad Jumps": "80â€“100 m", "Row": "500â€“1000 m", "Farmer Carry": "200 m", "Sandbag Lunges": "100 m", "Wall Balls": "75â€“100 reps"}};
let currentWeek = 1;

document.getElementById("z2hr").textContent = DATA.z2_hr;
document.getElementById("z2pace").textContent = DATA.z2_pace;

// ---- helpers ----
function load(key, fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch(e){ return fallback; } }
function save(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }


function pad2(n){ return String(n).padStart(2,'0'); }
function formatDateISO(iso){
  if(!iso) return "";
  const d = new Date(iso+"T00:00:00");
  const days = ["Dom","Lun","Mar","MiÃ©","Jue","Vie","SÃ¡b"];
  const months = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
  return days[d.getDay()] + " " + pad2(d.getDate()) + " " + months[d.getMonth()];
}
function dateFor(weekIndex, dayKey){
  const w = DATA.weeks.find(x=>x.week===weekIndex);
  if(!w || !w.monday) return null;
  const base = new Date(w.monday+"T00:00:00");
  const map = {"Lun":0,"Mar":1,"MiÃ©":2,"Jue":3,"Vie":4,"SÃ¡b":5,"Dom":6};
  const off = map[dayKey];
  if(off===undefined) return null;
  const d = new Date(base.getTime() + off*24*3600*1000);
  // return ISO yyyy-mm-dd in local-safe way
  const yyyy = d.getFullYear();
  const mm = pad2(d.getMonth()+1);
  const dd = pad2(d.getDate());
  return `${yyyy}-${mm}-${dd}`;
}

function fileToDataUrl(file, cb){ const r = new FileReader(); r.onload=()=>cb(r.result); r.readAsDataURL(file); }

// ---- branding ----
function applyBrand(){
  const b = load("nw_brand", null);
  const title = (b && b.title) ? b.title : "HYROX DÃºo";
  document.getElementById("teamTitle").textContent = title;

  const iso = b && b.iso;
  const logo = b && b.logo;

  const isoImg = document.getElementById("isoImg");
  const isoFallback = document.getElementById("isoFallback");
  if(iso){ isoImg.src=iso; isoImg.style.display="block"; isoFallback.style.display="none"; }
  else { isoImg.style.display="none"; isoFallback.style.display="block"; }

  const logoImg = document.getElementById("logoImg");
  if(logo){ logoImg.src=logo; logoImg.style.display="block"; }
  else { logoImg.style.display="none"; }
}
applyBrand();

// ---- rotation logic ----
function rotatedStations(weekIndex){
  const order = DATA.stations_order;
  const offset = (weekIndex - 1) % order.length;
  const seq = [];
  for(let i=0;i<order.length;i++) seq.push(order[(offset+i)%order.length]);
  return seq;
}
function splitForWeek(weekIndex){
  const seq = rotatedStations(weekIndex);
  const mon = seq.slice(0, DATA.split_sizes.Mon);
  const wed = seq.slice(DATA.split_sizes.Mon, DATA.split_sizes.Mon + DATA.split_sizes.Wed);
  const fri = seq.slice(DATA.split_sizes.Mon + DATA.split_sizes.Wed);
  return {mon, wed, fri};
}

// ---- modal ----
const overlay = document.getElementById("overlay");
const sheetTitle = document.getElementById("sheetTitle");
const sheetBody = document.getElementById("sheetBody");
function openModal(title, html){
  sheetTitle.textContent = title;
  sheetBody.innerHTML = html;
  overlay.classList.add("show");
}
function closeModal(){ overlay.classList.remove("show"); }
document.getElementById("close").addEventListener("click", closeModal);
overlay.addEventListener("click", (e)=>{ if(e.target===overlay) closeModal(); });

// Touch-friendly click helper (doesn't break desktop)
const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints>0);
function bindTap(el, fn){
  el.addEventListener("click", fn);
  if(isTouch) el.addEventListener("touchend", (e)=>{ e.preventDefault(); fn(); }, {passive:false});
}

// ---- week button (no native select) ----
const weekBtn = document.getElementById("weekBtn");
function setWeekLabel(wk){
  const w = DATA.weeks.find(x=>x.week===wk);
  weekBtn.textContent = w ? ("Semana " + w.week + " Â· " + w.label + " Â· " + w.km_target + " km") : "Semana â€”";
}
function openWeekPicker(){
  let html = '<div class="section"><div class="st">Elegir semana</div><div class="small">TocÃ¡ una semana para verla.</div></div>'
           + '<div class="weekList">';
  DATA.weeks.forEach(w=>{
    const active = (w.week===currentWeek);
    html += '<div class="weekItem" data-week="'+w.week+'" style="'+(active?'background:rgba(255,255,255,.10);':'')+'">'
         +  '<div class="w">Semana '+w.week+'</div>'
         +  '<div class="m">'+w.label+' Â· '+w.km_target+' km</div>'
         +  '</div>';
  });
  html += '</div>';
  openModal("Semanas", html);
  document.querySelectorAll(".weekItem").forEach(el=>{
    const wk = parseInt(el.getAttribute("data-week"),10);
    bindTap(el, ()=>{ renderWeek(wk); closeModal(); });
  });
}
bindTap(weekBtn, openWeekPicker);

// ---- day model ----
function badge(tag){
  if(tag==="Z2") return '<span class="badge z2">Z2</span>';
  if(tag==="TÃ‰CNICA") return '<span class="badge tech">TEC</span>';
  if(tag==="INTENSO") return '<span class="badge int">INT</span>';
  if(tag==="SIM") return '<span class="badge tech">SIM</span>';
  if(tag==="Z2 LARGO") return '<span class="badge z2">Z2 L</span>';
  if(tag==="REC") return '<span class="badge z2">REC</span>';
  if(tag==="RACE") return '<span class="badge int">RACE</span>';
  return tag;
}

function dayModel(weekIndex){
  const w = DATA.weeks.find(x=>x.week===weekIndex);
  const km = w.km_target;
  // Race week (taper) â€” carrera sÃ¡bado {race.strftime('%d %b %Y')}
  if(w && w.is_race_week){
    const hy = load("nw_hy", null);
    return [
      { key:"Lun", tag:"TÃ‰CNICA", km:3, title:"Hipertrofia ligera + TÃ©cnica",
        stations: splitForWeek(weekIndex).mon,
        details:[
          ["Hipertrofia", (hy?.tpl || DATA.hypertrophy.template)+" â€¢ (muy ligero) 2â€“3 ejercicios + PECHO suave (sin llegar al fallo)"],
          ["TÃ©cnica", "Transiciones limpias. RPE 6. Salir con hambre."]
        ]
      },
      { key:"Mar", tag:"Z2", km:4, title:"Z2 Suave",
        details:[["Z2", "20â€“30 min Z2. Nada de tempo."]]
      },
      { key:"MiÃ©", tag:"REC", km:0, title:"Descanso / movilidad",
        details:[["Rec", "Movilidad + activaciÃ³n 20â€“30 min. Dormir bien."]]
      },
      { key:"Jue", tag:"Z2", km:3, title:"Z2 + 4 strides",
        details:[["Z2", "15â€“20 min Z2 + 4Ã—15â€“20s strides (rec 60â€“90s)."]]
      },
      { key:"Vie", tag:"REC", km:0, title:"Descanso",
        details:[["Rec", "Caminar suave, movilidad. Preparar equipo."]]
      },
      { key:"SÃ¡b", tag:"RACE", km:0, title:"CARRERA â€” HYROX DÃºo",
        details:[["Race", "Objetivo: ejecutar transiciones y ritmo del dÃºo. No improvisar."]]
      },
      { key:"Dom", tag:"REC", km:0, title:"RecuperaciÃ³n",
        details:[["Rec", "Descanso total o paseo muy suave."]]
      }
    ];
  }


  // KM de running del bloque HYROX por SERIES (no 4.5 km lineales).
  // L/V (umbral): 5â€“6Ã—500 m => 2.5â€“3.0 km de run "de trabajo"
  // MiÃ© (tÃ©cnico): 3â€“4Ã—500 m => 1.5â€“2.0 km
  const seriesRun = (km<=27 ? 2.5 : 3.0);
  const techRun   = (km<=27 ? 1.5 : 2.0);

  let monKm = seriesRun;
  let wedKm = techRun;
  let friKm = seriesRun;

  const fixed=monKm+wedKm+friKm;
  const rem=Math.max(0, km-fixed);
  const tue=Math.max(0, Math.round(rem*0.22));
  const thu=Math.max(0, Math.round(rem*0.22));
  const sat=Math.max(0, Math.round(rem*0.46));
  const sun=Math.max(0, rem-(tue+thu+sat));

  const sp = splitForWeek(weekIndex);
  const sim = w.simulation;
  // Si hay simulaciÃ³n esta semana, NO tiene sentido llegar con el viernes a umbral.
  // Taper simple: viernes se vuelve tÃ©cnico (sin Ã¡cido) y se baja volumen para llegar fresco.
  const isSimWeek = (sim && sim.enabled);
  if(isSimWeek){
    const oldFri = friKm;
    friKm = Math.round(oldFri * 0.6 * 10)/10; // -40% aprox
  }


  const hy = load("nw_hy", null);

  return [
    { key:"Lun", tag:"INTENSO", km:monKm, title:"Hipertrofia + HYROX (Umbral)", stations:sp.mon, details:[
      ["Hipertrofia", (hy?.tpl || DATA.hypertrophy.template)+" â€¢ "+(hy?.mon || DATA.hypertrophy.Mon)],
      ["Formato", "SERIES (umbral): 500 m run + 2 estaciones Â· 5â€“6 series"],
      ["Series", "Ejemplo: S1 500 m + Pull + Push Â· S2 500 m + Ski + Push Â· S3 500 m + Ski + Pull"],
      ["Running", "Total objetivo 2.5â€“3.0 km Â· Umbral controlado"],
    ]},
    { key:"Mar", tag:"Z2", km:tue, title:"Z2 Trote", details:[
      ["Z2", "@ "+DATA.z2_hr+" ppm (~"+DATA.z2_pace+"/km). Si >150: bajÃ¡ o caminÃ¡ 30â€“60s."]
    ]},
    { key:"MiÃ©", tag:"TÃ‰CNICA", km:wedKm, title:"Hipertrofia + HYROX (TÃ©cnica)", stations:sp.wed, details:[
      ["Hipertrofia", (hy?.tpl || DATA.hypertrophy.template)+" â€¢ "+(hy?.wed || DATA.hypertrophy.Wed)],
      ["Formato", "TÃ‰CNICO: 500 m run + 1 estaciÃ³n Â· 3â€“4 series"],
      ["Objetivo", "Eficiencia, respiraciÃ³n y transiciones limpias"],
      ["EstaciÃ³n", "RotaciÃ³n suave de Ski / Push / Pull"],
    ]},
    { key:"Jue", tag:"Z2", km:thu, title:"Z2 Trote", details:[["Z2","Z2 estable. Nada de tempo disfrazado."]]},
    { key:"Vie", tag:(isSimWeek?"TÃ‰CNICA":"INTENSO"), km:friKm, title:("Hipertrofia + HYROX ("+(isSimWeek?"TÃ©cnica pre-sim":"Umbral")+")"), stations:sp.fri, details:[
      ["Hipertrofia", (hy?.tpl || DATA.hypertrophy.template)+" â€¢ "+(hy?.fri || DATA.hypertrophy.Fri)],
      ["Formato", "SERIES (umbral): 500 m run + 2 estaciones Â· 5â€“6 series"],
      ["Series", "Ejemplo: S1 500 m + Pull + Push Â· S2 500 m + Ski + Push Â· S3 500 m + Ski + Pull"],
      ["Running", "Total objetivo 2.5â€“3.0 km Â· Ãšltima serie prolija"],
    ]},
    { key:"SÃ¡b", tag:(sim && sim.enabled)?"SIM":"Z2 LARGO", km:sat, title:(sim && sim.enabled)?"SimulaciÃ³n estÃ¡ndar":"Z2 Largo", details:
      (sim && sim.enabled) ? [["SimulaciÃ³n", sim.label], ["Formato", DATA.sim_standard.join("\n")]] : [["Z2 Largo","Z2 continuo. Motor. Sin ego."]]
    },
    { key:"Dom", tag:"REC", km:sun, title:"RecuperaciÃ³n", details:[["Rec","Z2 muy suave o descanso total segÃºn fatiga."]]}
  ];
}




function openDay(d, weekIndex){
  const iso = dateFor(weekIndex, d.key);
  const header = `<div class="muted">${formatDateISO(iso)}</div>`;

  function sectionClass(h){
    const k = (h||"").toLowerCase();
    if(k.includes("hipertrof")) return {cls:"h-hyp", dot:"dot-hyp"};
    if(k.includes("hyrox") || k.includes("airox") || k.includes("ironx")) return {cls:"h-hyrox", dot:"dot-hyrox"};
    if(k.includes("run") || k.includes("z2") || k.includes("trote")) return {cls:"h-run", dot:"dot-run"};
    if(k.includes("dist")) return {cls:"h-dist", dot:"dot-dist"};
    if(k.includes("recom") || k.includes("nota")) return {cls:"h-rec", dot:"dot-dist"};
    return {cls:"h-dist", dot:"dot-dist"};
  }

  let left = '';
  (d.details||[]).forEach(([h,txt])=>{
    const sc = sectionClass(h);
    left += `<div class="card">
      <h4 class="${sc.cls}"><span><span class="dot ${sc.dot}"></span>${esc(h)}</span></h4>
      <div class="small">${esc(txt)}</div>
    </div>`;
  });

  let stations='';
  if(d.stations){
    stations = '<div class="card"><h4 class="h-hyrox"><span><span class="dot dot-hyrox"></span>Estaciones</span></h4><div class="chips">';
    d.stations.forEach(s=>{
      stations += `<span class="chip">${esc(s)}</span>`;
    });
    stations += '</div></div>';
  }

  const right = `
    <div class="card">
      <h4 class="h-dist"><span><span class="dot dot-dist"></span>Resumen</span></h4>
      <div class="summary">
        <div class="item">Intensidad<br><b>${esc(d.tag)}</b></div>
        <div class="item">KilÃ³metros<br><b>${esc(String(d.km))}</b></div>
      </div>
    </div>
    ${stations}
  `;

  const body = `
    ${header}
    <div class="modal-grid">
      <div>${left}</div>
      <div>${right}</div>
    </div>
  `;
  openModal(d.key+" Â· "+d.title, body);
}




function formatText(t){
  const s = esc(String(t||""));
  // If text contains line breaks, convert to bullet list when appropriate
  const lines = s.split("\n").map(x=>x.trim()).filter(Boolean);
  if(lines.length <= 1){
    return `<p>${s}</p>`;
  }
  // If many lines, render as bullets
  const items = lines.map(l=>{
    // strip leading bullet chars
    const clean = l.replace(/^â€¢\s*/,"");
    return `<li>${clean}</li>`;
  }).join("");
  return `<ul>${items}</ul>`;
}

function renderWeek(wk){
  currentWeek = wk;
  setWeekLabel(wk);
  const w = DATA.weeks.find(x=>x.week===wk);
  document.getElementById("kmTarget").textContent = w.km_target;
  document.getElementById("simYes").textContent = (w.simulation && w.simulation.enabled) ? "SÃ­" : "No";

  const row = document.getElementById("daysRow");
  row.innerHTML = "";
  const days = dayModel(wk);
  days.forEach(d=>{
    const b = document.createElement("div");
    b.className = "dayBtn";
    const iso = dateFor(wk, d.key);
    const ds = iso ? (' â€¢ ' + formatDateISO(iso)) : '';
    b.innerHTML = '<div class="d">'+d.key+' â€” '+badge(d.tag)+'</div>'
                + '<div class="t">'+d.title+ds+' â€¢ '+d.km+' km</div>';
    bindTap(b, ()=>openDay(d, wk));
    row.appendChild(b);
  });
}

// ---- buttons modals ----
bindTap(document.getElementById("btnSim"), ()=>{
  const w = DATA.weeks.find(x=>x.week===currentWeek);
  const title = (w.simulation && w.simulation.enabled) ? w.simulation.label : "Sin simulaciÃ³n esta semana";
  const list = (w.simulation && w.simulation.enabled) ? DATA.sim_standard : ["Esta semana: mantener Z2 largo."];
  let html = '<div class="section"><div class="st">'+esc(title)+'</div>';
  list.forEach(x=>{ html += '<div class="small">â€¢ '+esc(x)+'</div>'; });
  html += '</div>';
  openModal("SimulaciÃ³n estÃ¡ndar", html);
});

bindTap(document.getElementById("btnDuo"), ()=>{
  let html = '<div class="section"><div class="st">Roles</div>';
  DATA.duo_roles.forEach(x=>{ html += '<div class="small">â€¢ '+esc(x)+'</div>'; });
  html += '</div>';
  openModal("DÃºo", html);
});

bindTap(document.getElementById("btnBrand"), ()=>{
  const b = load("nw_brand", {title:"HYROX DÃºo", iso:null, logo:null});
  const hy = load("nw_hy", {tpl:DATA.hypertrophy.template, mon:DATA.hypertrophy.Mon, wed:DATA.hypertrophy.Wed, fri:DATA.hypertrophy.Fri});

  const html = `
    <div class="section">
      <div class="st">Branding</div>
      <div class="small">SubÃ­ tu isotipo/logotipo acÃ¡ y quedan guardados en este dispositivo.</div>
      <div style="height:10px"></div>
      <div class="st">Nombre</div><input id="tTitle" value="${esc(b.title||"")}"/>
      <div style="height:10px"></div>
      <div class="st">Isotipo</div><input id="tIso" type="file" accept="image/*"/>
      <div style="height:10px"></div>
      <div class="st">Logotipo</div><input id="tLogo" type="file" accept="image/*"/>
      <div style="height:12px"></div>
      <button id="saveBrand">Guardar</button> <button id="clearBrand2">Borrar</button>
    </div>

    <div class="section">
      <div class="st">Hipertrofia</div>
      <input id="hyTpl" value="${esc(hy.tpl||"")}" placeholder="Plantilla"/>
      <div style="height:8px"></div>
      <input id="hyMon" value="${esc(hy.mon||"")}" placeholder="Lunes"/>
      <div style="height:8px"></div>
      <input id="hyWed" value="${esc(hy.wed||"")}" placeholder="MiÃ©rcoles"/>
      <div style="height:8px"></div>
      <input id="hyFri" value="${esc(hy.fri||"")}" placeholder="Viernes"/>
      <div style="height:12px"></div>
      <button id="saveHy">Guardar hipertrofia</button>
    </div>
  `;
  openModal("Brand & Hipertrofia", html);

  const saveBrandBtn = document.getElementById("saveBrand");
  saveBrandBtn && bindTap(saveBrandBtn, ()=>{
    const cur = load("nw_brand", {}) || {};
    cur.title = (document.getElementById("tTitle").value || "").trim() || "HYROX DÃºo";
    const isoF = document.getElementById("tIso").files[0];
    const logoF = document.getElementById("tLogo").files[0];

    const done = ()=>{ save("nw_brand", cur); applyBrand(); closeModal(); };
    if(isoF){
      fileToDataUrl(isoF, (d)=>{
        cur.iso=d;
        if(logoF) fileToDataUrl(logoF, (dl)=>{ cur.logo=dl; done(); });
        else done();
      });
    } else if(logoF){
      fileToDataUrl(logoF, (dl)=>{ cur.logo=dl; done(); });
    } else done();
  });

  const clearBtn = document.getElementById("clearBrand2");
  clearBtn && bindTap(clearBtn, ()=>{ localStorage.removeItem("nw_brand"); applyBrand(); closeModal(); });

  const saveHyBtn = document.getElementById("saveHy");
  saveHyBtn && bindTap(saveHyBtn, ()=>{
    const hy2 = {
      tpl:(document.getElementById("hyTpl").value||"").trim(),
      mon:(document.getElementById("hyMon").value||"").trim(),
      wed:(document.getElementById("hyWed").value||"").trim(),
      fri:(document.getElementById("hyFri").value||"").trim(),
    };
    save("nw_hy", hy2);
    renderWeek(currentWeek);
    closeModal();
  });
});

// Pills
bindTap(document.getElementById("pillSeq"), ()=>{
  openModal("Secuencia HYROX",
    '<div class="section"><div class="st">Orden</div>'
    + '<div class="small">Ski â†’ Push â†’ Pull â†’ Burpees â†’ Row â†’ Farmer â†’ Lunges â†’ Wall Balls</div>'
    + '<div class="small" style="margin-top:8px">RotaciÃ³n: cada semana cambia el punto de inicio para que el miÃ©rcoles tÃ©cnico rote.</div></div>');
});
bindTap(document.getElementById("pillNotes"), ()=>{
  openModal("Notas",
    '<div class="section"><div class="st">Reglas</div>'
    + '<div class="small">â€¢ Mar/Jue: Z2 puro (motor).</div>'
    + '<div class="small">â€¢ MiÃ©: tÃ©cnica (control, no Ã¡cido).</div>'
    + '<div class="small">â€¢ L/V: umbral (intenso, pero sin ir a muerte todo el tiempo).</div></div>');
});
bindTap(document.getElementById("pillToday"), ()=>{
  const now = new Date();
  const map = ["Dom","Lun","Mar","MiÃ©","Jue","Vie","SÃ¡b"];
  const key = map[now.getDay()];
  const d = dayModel(currentWeek).find(x=>x.key===key) || dayModel(currentWeek)[0];
  openDay(d, currentWeek);
});

// init
setWeekLabel(1);
renderWeek(1);

// Canvas particles
const canvas = document.getElementById('bg');
const ctx = canvas.getContext('2d');
let W=0,H=0,DPR=1;
function resize(){
  DPR = Math.max(1, window.devicePixelRatio || 1);
  W = canvas.width = Math.floor(window.innerWidth * DPR);
  H = canvas.height = Math.floor(window.innerHeight * DPR);
  canvas.style.width = window.innerWidth + "px";
  canvas.style.height = window.innerHeight + "px";
}
window.addEventListener('resize', resize);
resize();

const cfg = { density: 0.00008, max: 140, speed: 0.25, linkDist: 120, mouseDist: 140 };
let parts=[];
function rnd(n){ return Math.random()*n; }
function makeP(){ return { x:rnd(W), y:rnd(H), vx:(Math.random()-.5)*cfg.speed*DPR, vy:(Math.random()-.5)*cfg.speed*DPR, r:(1.2+Math.random()*0.8)*DPR }; }
function initParts(){
  const target = Math.min(cfg.max, Math.floor(W*H*cfg.density));
  parts = Array.from({length:target}, makeP);
}
initParts();
window.addEventListener('resize', initParts);

let mouse={x:W/2,y:H/2,active:false};
window.addEventListener('mousemove', e=>{ mouse={x:e.clientX*DPR, y:e.clientY*DPR, active:true}; });
window.addEventListener('touchmove', e=>{
  const t=e.touches[0]; if(!t) return;
  mouse={x:t.clientX*DPR, y:t.clientY*DPR, active:true};
}, {passive:true});
window.addEventListener('mouseleave', ()=>{ mouse.active=false; });

function frame(){
  ctx.clearRect(0,0,W,H);
  for(const p of parts){
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0||p.x>W) p.vx*=-1;
    if(p.y<0||p.y>H) p.vy*=-1;
    if(mouse.active){
      const dx=p.x-mouse.x, dy=p.y-mouse.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      const m=cfg.mouseDist*DPR;
      if(dist<m && dist>0.01){
        const f=(1 - dist/m)*0.6;
        p.vx += (dx/dist)*f*0.02*DPR;
        p.vy += (dy/dist)*f*0.02*DPR;
      }
    }
  }
  for(let i=0;i<parts.length;i++) for(let j=i+1;j<parts.length;j++) {
    const a=parts[i], b=parts[j];
    const dx=a.x-b.x, dy=a.y-b.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const max=cfg.linkDist*DPR;
    if(dist<max){
      const alpha=(1 - dist/max)*0.35;
      ctx.strokeStyle="rgba(255,255,255,"+alpha+")";
      ctx.lineWidth=1*DPR;
      ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
    }
  }
  for(const p of parts){
    ctx.fillStyle="rgba(255,255,255,.75)";
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  }
  requestAnimationFrame(frame);
}
frame();
</script>

  </div>

  <script id="nw-gate-script">
    (function () {
      const PASSWORD = "Avant.00"; // <-- CambiÃ¡ la clave acÃ¡ si querÃ©s

      const KEY = "nw-unlocked-until";
      const TTL_MS = 12 * 60 * 60 * 1000; // 12 horas

      function isUnlocked() {
        const until = parseInt(localStorage.getItem(KEY) || "0", 10);
        return Date.now() < until;
      }

      function lockUI() {
        document.body.classList.add("nw-locked");
        const gate = document.getElementById("nw-gate");
        if (gate) gate.style.display = "flex";
      }

      function unlockUI() {
        document.body.classList.remove("nw-locked");
        const gate = document.getElementById("nw-gate");
        if (gate) gate.style.display = "none";
      }

      window.NW_unlock = function () {
        const input = document.getElementById("nw-pass");
        const err = document.getElementById("nw-err");
        const val = (input?.value || "").trim();

        if (val === PASSWORD) {
          localStorage.setItem(KEY, String(Date.now() + TTL_MS));
          if (err) err.style.display = "none";
          unlockUI();
        } else {
          if (err) err.style.display = "block";
        }
      };

      window.NW_gateKey = function (e) {
        if (e.key === "Enter") window.NW_unlock();
      };

      // Boot
      if (isUnlocked()) {
        unlockUI();
      } else {
        lockUI();
        setTimeout(() => {
          const input = document.getElementById("nw-pass");
          if (input) input.focus();
        }, 50);
      }
    })();
  </script>

</body>
</html>
